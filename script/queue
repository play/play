#!/usr/bin/env ruby
#
# Manages your queue for you. This is a long-running process that prunes songs
# we've already played from the playlist and adds interesting songs to the
# queue so the music ain't ever stop.

require './config/environment'

tracked_channels = []

loop do
  all_channels = Channel.all

  # Check to see if any of the channels we're tracking have been removed.
  # If so, remove them from the ones we're tracking.
  tracked_channels.each do |channel|
    tracked_channels.delete(channel) unless all_channels.include?(channel)
  end

  # Check to see if any new channels have been added.
  # If so, add them to the channels that we're tracking.
  all_channels.each do |channel|
    tracked_channels << channel unless tracked_channels.include?(channel)
  end

  # Loop through all the currently tracked channels to see if we need to bump
  # the queue.
  tracked_channels.each do |channel|
    if channel.queue.size < Channel::MIN_QUEUE_SIZE
      channel.autoqueue(Channel::MIN_QUEUE_SIZE - channel.queue.size)
    end
  end
  sleep 10
end
